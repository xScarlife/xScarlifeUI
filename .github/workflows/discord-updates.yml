name: Discord Updates

on:
  push:
    branches: ["main"]
    paths:
      - "xScarlifeUI - Retail/**"
      - "xScarlifeUI - Classic Era/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post embed to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          SITE_URL: https://xscarlife-gaming.com/xscarlifeui-import-strings/
          MODIFIED_JSON: ${{ toJson(github.event.head_commit.modified) }}
          ADDED_JSON: ${{ toJson(github.event.head_commit.added) }}
        run: |
          python3 - <<'PY'
          import os, json, urllib.request

          webhook = os.environ["DISCORD_WEBHOOK"]
          actor = os.environ.get("ACTOR","")
          repo = os.environ.get("REPO","")
          commit_msg = os.environ.get("COMMIT_MSG","")
          commit_url = os.environ.get("COMMIT_URL","")
          site_url = os.environ.get("SITE_URL","")

          modified = json.loads(os.environ.get("MODIFIED_JSON","[]") or "[]")
          added = json.loads(os.environ.get("ADDED_JSON","[]") or "[]")

          files = []
          for f in (added + modified):
            if f not in files:
              files.append(f)

          if not files:
            files_list = "â€”"
          else:
            max_lines = 12
            shown = files[:max_lines]
            files_list = "\n".join([f"â€¢ `{f}`" for f in shown])
            if len(files) > max_lines:
              files_list += f"\nâ€¢ `â€¦and {len(files)-max_lines} more`"

          payload = {
            "username": "xScarlifeUI Updates",
            "embeds": [
              {
                "title": "xScarlifeUI update pushed",
                "url": commit_url,
                "description": f"ðŸ‘‰ **Grab the latest import string here:**\n{site_url}",
                "color": 16689199,
                "fields": [
                  {"name": "Repo", "value": repo, "inline": True},
                  {"name": "By", "value": actor, "inline": True},
                  {"name": "Commit", "value": commit_msg, "inline": False},
                  {"name": "Updated file(s)", "value": files_list, "inline": False},
                ],
                "footer": {"text": "xScarlife Gaming"},
              }
            ],
          }

          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(webhook, data=data, headers={"Content-Type":"application/json"})
          with urllib.request.urlopen(req) as resp:
            resp.read()
          print("Discord notified successfully.")
          PY
